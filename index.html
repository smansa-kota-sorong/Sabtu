<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Halaman 1 • Absensi XII-A2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .bg-app { background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%); min-height: 100vh; }
    .header-bar { background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); }
    .card { background: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
    .btn { transition: all .2s ease; } .btn:hover { transform: translateY(-1px); }
    .spin { animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
    .fade { animation: fade .35s ease; } @keyframes fade { from {opacity:0; transform: translateY(8px);} to {opacity:1; transform: translateY(0);} }
    .status-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .5rem; }
    @media (min-width: 640px){ .status-grid { display: flex; flex-wrap: wrap; gap: .5rem; } }
    .nav-tab { color: #ffffff; border: 1px solid rgba(255,255,255,.25); border-radius: 9999px; background: rgba(255,255,255,.08); box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .nav-tab:hover { background: rgba(255,255,255,.16); }
    .nav-tab.active { color: #fff; background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.6); box-shadow: 0 6px 16px rgba(0,0,0,.18); }
    .app-bg-2 { background: radial-gradient(1200px 800px at 0% 0%, #dbeafe 0%, #f5d0fe 45%, #fdf2f8 75%, #eef2ff 100%); }
    .table-wrap { max-height: 60vh; overflow: auto; }
    .th-sticky { position: sticky; top: 0; background: #f8fafc; z-index: 5; }
    .badge { padding: .25rem .5rem; border-radius: 999px; font-weight: 700; font-size: .75rem; display: inline-flex; align-items: center; gap: .35rem;}
    .badge-Hadir { background:#dcfce7; color:#166534; }
    .badge-Sakit { background:#fef9c3; color:#854d0e; }
    .badge-Izin { background:#e0e7ff; color:#3730a3; }
    .badge-Alpa { background:#ffe4e6; color:#9f1239; }
    .badge-Bolos { background:#fae8ff; color:#86198f; }
    .status-dot{ width:.5rem; height:.5rem; border-radius:999px; display:inline-block;}
    .hidden-section { display: none; }
    .gate-bg { background: radial-gradient(900px 600px at 10% 0%, #dbeafe 0%, #e9d5ff 45%, #fce7f3 80%); min-height: 100vh; }
    .chip { background:#eef2ff; color:#3730a3; border-radius:999px; padding:.25rem .5rem; font-size:.75rem; font-weight:700; }
  </style>
</head>
<body class="bg-app">

  <!-- GATE: Pilih Nama Petugas (tanpa password) -->
  <section id="gateScreen" class="gate-bg flex items-center justify-center px-4 py-10">
    <div class="max-w-lg w-full">
      <div class="card rounded-2xl p-6 sm:p-8 fade">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 rounded-xl bg-indigo-600 text-white flex items-center justify-center shadow">
            <i class="fa-solid fa-id-card-clip text-2xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-extrabold text-gray-900">Halaman 1 • Masuk</h1>
            <p class="text-gray-500 text-sm">Pilih nama petugas dari sheet Login</p>
          </div>
        </div>

        <div id="gateInfo" class="p-4 rounded-xl bg-indigo-50 border border-indigo-200 text-indigo-900 text-sm mb-5">
          Memuat daftar petugas dari sheet Login...
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Petugas</label>
            <select id="userSelect" class="w-full rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-3 text-gray-700">
              <option value="">-- Pilih nama --</option>
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <div class="text-xs text-gray-500 mb-1">Role</div>
              <div id="rolePreview" class="chip">-</div>
            </div>
            <div>
              <div class="text-xs text-gray-500 mb-1">Halaman</div>
              <div id="pagePreview" class="chip">-</div>
            </div>
          </div>

          <button id="enterBtn" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold" disabled>
            <i class="fa-solid fa-right-to-bracket mr-2"></i>Masuk Halaman 1
          </button>

          <div class="flex items-center justify-between">
            <button id="rememberToggle" class="py-2 px-3 rounded-lg bg-white border text-gray-700 text-sm">
              <i class="fa-regular fa-circle-check mr-1 text-emerald-600"></i>Ingat perangkat ini
            </button>
            <button id="refreshLoginList" class="text-sm text-indigo-700 hover:underline">
              <i class="fa-solid fa-rotate-right mr-1"></i>Muat ulang daftar
            </button>
          </div>
        </div>

        <div class="mt-6 text-xs text-gray-500">
          Tidak ada kolom password di halaman ini. Jika butuh pembatasan sungguhan, batasi akses di Apps Script (Only specific people).
        </div>
      </div>
    </div>
  </section>

  <!-- APP CONTENT (muncul setelah pilih nama) -->
  <div id="appContent" class="hidden">
    <!-- Header + Nav Tabs -->
    <header class="header-bar text-white">
      <div class="max-w-7xl mx-auto px-4 py-5 sm:py-6">
        <div class="flex items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-clipboard-check text-2xl"></i>
            <div>
              <h1 class="text-xl sm:text-2xl font-bold">Absensi XII-A2</h1>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
              <div id="nowDate" class="font-semibold"></div>
              <div id="nowTime" class="text-indigo-100 text-sm"></div>
            </div>
            <div id="whoBox" class="hidden sm:flex items-center gap-2 bg-white/10 px-3 py-2 rounded-lg">
              <i class="fa-solid fa-user"></i>
              <span id="whoName" class="font-semibold"></span>
              <span id="whoRole" class="text-xs bg-white/20 rounded px-2 py-0.5"></span>
            </div>
            <button id="exitBtn" class="btn bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm font-semibold" title="Keluar ke Halaman 1">
              <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </button>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-3 flex-wrap">
          <button id="tabAbsensi" class="nav-tab active px-5 py-2.5 rounded-full font-bold text-sm tracking-wide" onclick="switchTab('absen')">
            <i class="fa-solid fa-clipboard-check mr-2"></i>Absen
          </button>
          <button id="tabRekapan" class="nav-tab px-5 py-2.5 rounded-full font-bold text-sm tracking-wide" onclick="goToRekapan()">
            <i class="fa-solid fa-chart-pie mr-2"></i>Rekapan
          </button>
          <button id="tabRekapSemester" class="nav-tab px-5 py-2.5 rounded-full font-bold text-sm tracking-wide" onclick="switchTab('rekapSemester')">
            <i class="fa-solid fa-calendar-days mr-2"></i>Rekapan Semester
          </button>
          <button id="tabEditAbsensi" class="nav-tab px-5 py-2.5 rounded-full font-bold text-sm tracking-wide" onclick="switchTab('edit')">
            <i class="fa-solid fa-pen-to-square mr-2"></i>Edit Absensi
          </button>
          <span class="ml-auto text-xs text-indigo-100 sm:hidden" id="clockMini"></span>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
      <!-- SECTION: ABSENSI -->
      <section id="sectionAbsen" class="fade">
        <!-- Pengaturan -->
        <section class="card rounded-xl p-5 sm:p-6 mb-6">
          <div class="grid lg:grid-cols-2 gap-6">
            <!-- Kolom kiri: Tanggal + tombol Rekapan -->
            <div>
              <div class="mb-3 flex items-center justify-between gap-3 flex-wrap">
                <div class="text-sm text-gray-500">Navigasi cepat</div>
                <div class="flex items-center gap-2 flex-wrap">
                  <button onclick="goToRekapan()" class="btn bg-violet-600 hover:bg-violet-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                    <i class="fa-solid fa-chart-pie mr-2"></i>Rekapan
                  </button>
                  <button onclick="switchTab('rekapSemester')" class="btn bg-indigo-700 hover:bg-indigo-800 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                    <i class="fa-solid fa-calendar-days mr-2"></i>Rekapan Semester
                  </button>
                  <button onclick="switchTab('edit')" class="btn bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                    <i class="fa-solid fa-pen-to-square mr-2"></i>Edit Absensi
                  </button>
                </div>
              </div>

              <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fa-regular fa-calendar-days text-indigo-600 mr-2"></i>Pilih Tanggal
              </h3>
              <div class="relative">
                <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-500">
                  <i class="fa-regular fa-calendar"></i>
                </div>
                <input id="attendanceDate" type="date"
                      class="w-full pl-10 pr-4 py-3 rounded-lg border border-indigo-200 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                      onchange="updateSelectedDate()">
              </div>
              <div class="flex gap-2 mt-3">
                <button onclick="setToday()" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                  <i class="fa-solid fa-bolt mr-2"></i>Hari Ini
                </button>
                <button onclick="setYesterday()" class="btn bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                  <i class="fa-solid fa-arrow-left mr-2"></i>Kemarin
                </button>
              </div>
              <div class="mt-4 p-3 bg-white rounded-lg border border-indigo-200">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 flex items-center">
                    <i class="fa-solid fa-circle-info text-indigo-600 mr-2"></i>Tanggal Terpilih
                  </span>
                  <div class="flex items-center">
                    <span id="selectedDateDisplay" class="font-semibold text-indigo-700 text-sm">Belum dipilih</span>
                    <span id="dateBadge" class="ml-2 px-2 py-0.5 text-xs font-medium rounded-full"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Kolom kanan: Jam -->
            <div>
              <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fa-regular fa-clock text-violet-600 mr-2"></i>Pilih Jam ke / Bimbel
              </h3>
              <div class="mb-3">
                <h4 class="text-sm text-gray-600 mb-2">Jam Pelajaran</h4>
                <div class="grid grid-cols-3 sm:grid-cols-5 lg:grid-cols-9 gap-2">
                  <button id="jam1" onclick="selectSchedule('jam1')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 1</button>
                  <button id="jam2" onclick="selectSchedule('jam2')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 2</button>
                  <button id="jam3" onclick="selectSchedule('jam3')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 3</button>
                  <button id="jam4" onclick="selectSchedule('jam4')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 4</button>
                  <button id="jam5" onclick="selectSchedule('jam5')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 5</button>
                  <button id="jam6" onclick="selectSchedule('jam6')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 6</button>
                  <button id="jam7" onclick="selectSchedule('jam7')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 7</button>
                  <button id="jam8" onclick="selectSchedule('jam8')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 8</button>
                  <button id="jam9" onclick="selectSchedule('jam9')" class="schedule-btn bg-indigo-100 hover:bg-indigo-200 text-indigo-800 px-3 py-2 rounded-lg text-xs font-semibold">Jam 9</button>
                </div>
              </div>
              <div>
                <h4 class="text-sm text-gray-600 mb-2">Bimbel</h4>
                <div class="grid grid-cols-2 gap-2 max-w-md">
                  <button id="bimbel1" onclick="selectSchedule('bimbel1')" class="schedule-btn bg-fuchsia-100 hover:bg-fuchsia-200 text-fuchsia-800 px-3 py-2 rounded-lg text-xs font-semibold">Bimbel 1</button>
                  <button id="bimbel2" onclick="selectSchedule('bimbel2')" class="schedule-btn bg-fuchsia-100 hover:bg-fuchsia-200 text-fuchsia-800 px-3 py-2 rounded-lg text-xs font-semibold">Bimbel 2</button>
                </div>
              </div>
              <div class="mt-4 p-3 bg-white rounded-lg border border-violet-200">
                <p class="text-sm text-gray-700">
                  Jadwal Terpilih: <span id="selectedSchedule" class="font-semibold text-violet-700">Belum dipilih</span>
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- Daftar Siswa -->
        <section class="card rounded-xl p-5 sm:p-6 mb-6">
          <div class="flex items-center justify-between gap-3">
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center">
              <i class="fa-solid fa-users text-indigo-600 mr-2"></i>Daftar Siswa
              <span id="studentCountLabel" class="ml-2 text-gray-500 text-base font-semibold"></span>
            </h3>
            <button onclick="markAllPresent()" class="btn bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
              <i class="fa-solid fa-check-double mr-2"></i>Hadir Semua
            </button>
          </div>
          <div id="studentsList" class="grid gap-3 sm:gap-4 mt-4"></div>
        </section>

        <!-- Statistik singkat -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
          <div class="card rounded-lg p-4 text-center">
            <div class="text-sm text-gray-600 mb-1">Total Siswa</div>
            <div id="totalCount" class="text-2xl font-extrabold text-gray-800">0</div>
          </div>
          <div class="card rounded-lg p-4 text-center">
            <div class="text-sm text-blue-700 mb-1">Laki-Laki</div>
            <div id="maleCount" class="text-2xl font-extrabold text-blue-700">0</div>
          </div>
          <div class="card rounded-lg p-4 text-center">
            <div class="text-sm text-pink-700 mb-1">Perempuan</div>
            <div id="femaleCount" class="text-2xl font-extrabold text-pink-700">0</div>
          </div>
          <div class="card rounded-lg p-4 text-center">
            <div class="text-sm text-emerald-700 mb-1">Islam</div>
            <div class="text-2xl font-extrabold text-emerald-700">11</div>
            <div class="mt-2 text-xs text-gray-600 flex items-center justify-center gap-3">
              <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span>Laki-Laki: <span class="font-semibold text-gray-800">5</span></span>
              <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-pink-500 inline-block"></span>Perempuan: <span class="font-semibold text-gray-800">6</span></span>
            </div>
          </div>
          <div class="card rounded-lg p-4 text-center">
            <div class="text-sm text-violet-700 mb-1">Protestan</div>
            <div class="text-2xl font-extrabold text-violet-700">25</div>
            <div class="mt-2 text-xs text-gray-600 flex items-center justify-center gap-3">
              <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span>Laki-Laki: <span class="font-semibold text-gray-800">9</span></span>
              <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-pink-500 inline-block"></span>Perempuan: <span class="font-semibold text-gray-800">16</span></span>
            </div>
          </div>
        </section>

        <!-- Kirim -->
        <section class="text-center mb-10">
          <button id="submitBtn" onclick="submitAttendance()" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow">
            <i class="fa-solid fa-paper-plane mr-2"></i>Kirim Absensi
          </button>
          <p id="urlWarning" class="mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 inline-block px-3 py-2 rounded">
            Pastikan URL Web App sudah benar di bagian konfigurasi.
          </p>
        </section>

        <!-- Pesan -->
        <div id="successMessage" class="hidden bg-emerald-100 border border-emerald-300 text-emerald-800 px-4 py-3 rounded-xl mb-6 text-center max-w-2xl mx-auto">
          <i class="fa-solid fa-circle-check mr-2"></i>Absen terkirim ke Google Sheets!
        </div>
        <div id="errorMessage" class="hidden bg-rose-100 border border-rose-300 text-rose-800 px-4 py-3 rounded-xl mb-8 text-center max-w-2xl mx-auto"></div>
      </section>

      <!-- SECTION: REKAPAN (satu tanggal) -->
      <section id="sectionRekap" class="hidden-section app-bg-2 rounded-2xl p-0">
        <div class="p-5 sm:p-7">
          <section class="card rounded-2xl p-5 sm:p-7 mb-6">
            <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-filter text-indigo-600"></i> Filter Rekap
              </h2>
              <div class="flex items-center gap-2 flex-wrap">
                <button id="refreshBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                  <i class="fa-solid fa-rotate-right mr-1"></i> Refresh Data
                </button>
              </div>
            </div>

            <div class="grid lg:grid-cols-4 md:grid-cols-2 grid-cols-1 gap-4">
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Tanggal</label>
                <input id="rekapDate" type="date" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Jam ke / Bimbel</label>
                <select id="jamFilter" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                  <option value="">Semua</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Status</label>
                <select id="statusFilter" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                  <option value="">Semua</option>
                  <option>Hadir</option>
                  <option>Sakit</option>
                  <option>Izin</option>
                  <option>Alpa</option>
                  <option>Bolos</option>
                </select>
              </div>
              <div class="md:col-span-2 lg:col-span-1">
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Cari Nama</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-500"><i class="fa-solid fa-magnifying-glass"></i></span>
                  <input id="searchName" type="text" placeholder="Ketik sebagian nama..." class="w-full pl-10 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                </div>
              </div>
            </div>

            <div id="infoBar" class="mt-4 text-sm text-gray-600">
              Menampilkan <span id="matchCount" class="font-semibold text-indigo-700">0</span> baris.
            </div>
          </section>

          <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Hadir</div><div id="sumHadir" class="text-2xl font-extrabold text-emerald-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Sakit</div><div id="sumSakit" class="text-2xl font-extrabold text-amber-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Izin</div><div id="sumIzin" class="text-2xl font-extrabold text-indigo-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Alpa</div><div id="sumAlpa" class="text-2xl font-extrabold text-rose-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Bolos</div><div id="sumBolos" class="text-2xl font-extrabold text-fuchsia-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Total</div><div id="sumTotal" class="text-2xl font-extrabold text-gray-800">0</div></div>
          </section>

          <section class="card rounded-2xl p-5 sm:p-7">
            <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-table-list text-indigo-600"></i> Rekap per Nama
              </h2>
              <button id="exportBtn" class="btn bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                <i class="fa-solid fa-file-arrow-down mr-1"></i> Unduh CSV Rekap
              </button>
            </div>

            <div class="table-wrap border rounded-xl">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="th-sticky border-b">
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">No.</th>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Nama Lengkap</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Hadir</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Sakit</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Izin</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Alpa</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Bolos</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Total</th>
                  </tr>
                </thead>
                <tbody id="rekapBody" class="divide-y"></tbody>
              </table>
            </div>

            <div id="loadingBox" class="flex items-center gap-2 text-indigo-700 mt-4">
              <i class="fa-solid fa-spinner spin"></i> Memuat data...
            </div>
            <div id="errorBox" class="hidden mt-4 p-3 rounded-lg border bg-rose-50 border-rose-300 text-rose-800">
              <i class="fa-solid fa-triangle-exclamation mr-1"></i> Gagal memuat data. Coba klik Refresh.
            </div>
            <div id="emptyBox" class="hidden mt-4 p-3 rounded-lg border bg-amber-50 border-amber-300 text-amber-800">
              Tidak ada data sesuai filter.
            </div>
          </section>
        </div>
      </section>

      <!-- SECTION: REKAPAN SEMESTER (rentang tanggal) -->
      <section id="sectionRekapSemester" class="hidden-section app-bg-2 rounded-2xl p-0">
        <div class="p-5 sm:p-7">
          <section class="card rounded-2xl p-5 sm:p-7 mb-6">
            <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-calendar-days text-indigo-600"></i> Filter Rekap Semester
              </h2>
              <div class="flex items-center gap-2 flex-wrap">
                <button id="refreshBtnSem" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                  <i class="fa-solid fa-rotate-right mr-1"></i> Refresh Data
                </button>
              </div>
            </div>

            <div class="grid lg:grid-cols-5 md:grid-cols-3 grid-cols-1 gap-4">
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Tanggal Mulai</label>
                <input id="semStartDate" type="date" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Tanggal Selesai</label>
                <input id="semEndDate" type="date" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Jam ke / Bimbel</label>
                <select id="jamFilterSem" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                  <option value="">Semua</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Status</label>
                <select id="statusFilterSem" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                  <option value="">Semua</option>
                  <option>Hadir</option>
                  <option>Sakit</option>
                  <option>Izin</option>
                  <option>Alpa</option>
                  <option>Bolos</option>
                </select>
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Cari Nama</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-500"><i class="fa-solid fa-magnifying-glass"></i></span>
                  <input id="searchNameSem" type="text" placeholder="Ketik sebagian nama..." class="w-full pl-10 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                </div>
              </div>
            </div>

            <div id="infoBarSem" class="mt-4 text-sm text-gray-600">
              Menampilkan <span id="matchCountSem" class="font-semibold text-indigo-700">0</span> baris.
            </div>
          </section>

          <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 mb-6">
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Hadir</div><div id="sumHadirSem" class="text-2xl font-extrabold text-emerald-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Sakit</div><div id="sumSakitSem" class="text-2xl font-extrabold text-amber-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Izin</div><div id="sumIzinSem" class="text-2xl font-extrabold text-indigo-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Alpa</div><div id="sumAlpaSem" class="text-2xl font-extrabold text-rose-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Bolos</div><div id="sumBolosSem" class="text-2xl font-extrabold text-fuchsia-700">0</div></div>
            <div class="card rounded-xl p-4 text-center"><div class="text-sm text-gray-600 mb-1">Total</div><div id="sumTotalSem" class="text-2xl font-extrabold text-gray-800">0</div></div>
          </section>

          <section class="card rounded-2xl p-5 sm:p-7">
            <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-table-list text-indigo-600"></i> Rekap Semester per Nama
              </h2>
              <button id="exportBtnSem" class="btn bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                <i class="fa-solid fa-file-arrow-down mr-1"></i> Unduh CSV Rekap Semester
              </button>
            </div>

            <div class="table-wrap border rounded-xl">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="th-sticky border-b">
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">No.</th>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Nama Lengkap</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Hadir</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Sakit</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Izin</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Alpa</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Bolos</th>
                    <th class="text-center px-4 py-3 font-semibold text-gray-700">Total</th>
                  </tr>
                </thead>
                <tbody id="rekapBodySem" class="divide-y"></tbody>
              </table>
            </div>

            <div id="loadingBoxSem" class="hidden items-center gap-2 text-indigo-700 mt-4">
              <i class="fa-solid fa-spinner spin"></i> Memuat data...
            </div>
            <div id="errorBoxSem" class="hidden mt-4 p-3 rounded-lg border bg-rose-50 border-rose-300 text-rose-800">
              <i class="fa-solid fa-triangle-exclamation mr-1"></i> Gagal memuat data. Coba klik Refresh.
            </div>
            <div id="emptyBoxSem" class="hidden mt-4 p-3 rounded-lg border bg-amber-50 border-amber-300 text-amber-800">
              Tidak ada data sesuai filter.
            </div>
          </section>
        </div>
      </section>

      <!-- SECTION: EDIT ABSENSI (Demo) -->
      <section id="sectionEdit" class="hidden-section app-bg-2 rounded-2xl p-0">
        <div class="p-5 sm:p-7">
          <section class="card rounded-2xl p-5 sm:p-7 mb-6">
            <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fa-solid fa-pen-to-square text-indigo-600"></i> Edit Absensi
                <span class="ml-2 text-xs font-bold px-2 py-0.5 rounded-full bg-amber-100 text-amber-800">Demo</span>
              </h2>
              <div class="flex items-center gap-2 flex-wrap">
                <button id="saveEditsBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                  <i class="fa-solid fa-floppy-disk mr-1"></i> Simpan Perubahan (Demo)
                </button>
                <button id="exportEditsBtn" class="btn bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                  <i class="fa-solid fa-file-arrow-down mr-1"></i> Unduh CSV Perubahan
                </button>
              </div>
            </div>

            <div class="grid lg:grid-cols-4 md:grid-cols-2 grid-cols-1 gap-4">
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Tanggal</label>
                <input id="editDate" type="date" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
              </div>
              <div>
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Jam ke / Bimbel</label>
                <select id="jamFilterEdit" class="w-full rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                  <option value="">Semua</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Cari Nama</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-500"><i class="fa-solid fa-magnifying-glass"></i></span>
                  <input id="searchNameEdit" type="text" placeholder="Ketik sebagian nama..." class="w-full pl-10 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none p-2.5 text-gray-700">
                </div>
              </div>
            </div>

            <div class="mt-4 text-sm text-gray-600">
              Menampilkan <span id="matchCountEdit" class="font-semibold text-indigo-700">0</span> baris untuk tanggal dan pilihan di atas.
            </div>
            <div class="mt-3 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded p-2">
              Perubahan akan tersimpan sebagai contoh (Demo). Hubungi saya untuk menyambungkan ke Web App agar pembaruan dilakukan ke Google Sheets.
            </div>
          </section>

          <section class="card rounded-2xl p-5 sm:p-7">
            <div class="table-wrap border rounded-xl">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="th-sticky border-b">
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">No.</th>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Nama Lengkap</th>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Jam ke</th>
                    <th class="text-left px-4 py-3 font-semibold text-gray-700">Status</th>
                  </tr>
                </thead>
                <tbody id="editBody" class="divide-y"></tbody>
              </table>
            </div>

            <div id="editSaveMessage" class="hidden mt-4 p-3 rounded-lg border bg-emerald-50 border-emerald-300 text-emerald-800">
              <i class="fa-solid fa-circle-check mr-1"></i> Perubahan tersimpan (Demo). Kirim endpoint jika ingin tersambung ke Google Sheets sungguhan.
            </div>
            <div id="editErrorMessage" class="hidden mt-4 p-3 rounded-lg border bg-rose-50 border-rose-300 text-rose-800">
              <i class="fa-solid fa-triangle-exclamation mr-1"></i> Gagal menyimpan (Demo). Coba lagi atau cek koneksi.
            </div>
            <div id="emptyBoxEdit" class="hidden mt-4 p-3 rounded-lg border bg-amber-50 border-amber-300 text-amber-800">
              Tidak ada data sesuai filter.
            </div>
          </section>
        </div>
      </section>
    </main>

    <footer class="text-center text-gray-600 py-10">
      © 2025 • Absensi & Rekapan
    </footer>
  </div>

  <script>
    // ================== Konfigurasi ==================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzSP_Qfg4KSRP9yj2_EuZDqDgmWnEFbxRfZIarCIWEs5mmWaxZBqZzLB7saYWaunKRK/exec';
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQOMwwK9rdcEfJ_vQvYMRZmTJMLsSyDvOVn5c-DU-Id4HDkwSzdTChFUqMrWH69WNwhtfqkilp8ZgrS/pub?gid=1872719135&single=true&output=csv';
    let LOGIN_CSV_URL = '';

    // ================== Gate (Pilih Petugas) ==================
    const gateScreen = document.getElementById('gateScreen');
    const appContent = document.getElementById('appContent');
    const gateInfo = document.getElementById('gateInfo');
    const userSelect = document.getElementById('userSelect');
    const rolePreview = document.getElementById('rolePreview');
    const pagePreview = document.getElementById('pagePreview');
    const enterBtn = document.getElementById('enterBtn');
    const refreshLoginList = document.getElementById('refreshLoginList');
    const rememberToggle = document.getElementById('rememberToggle');
    const whoBox = document.getElementById('whoBox');
    const whoName = document.getElementById('whoName');
    const whoRole = document.getElementById('whoRole');

    let rememberDevice = true;
    let loginRows = [];
    let currentUser = null;

    function showApp(){
      gateScreen.classList.add('hidden');
      appContent.classList.remove('hidden');
      sessionStorage.setItem('enteredV26', '1');
      if (rememberDevice) localStorage.setItem('enteredV26Remember', '1');
      if (currentUser) {
        whoBox.classList.remove('hidden');
        whoName.textContent = currentUser.Username || currentUser['Nama'] || '(Tanpa Nama)';
        whoRole.textContent = currentUser.Role ? currentUser.Role : 'User';
      } else {
        whoBox.classList.add('hidden');
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function showGate(){
      appContent.classList.add('hidden');
      gateScreen.classList.remove('hidden');
      sessionStorage.removeItem('enteredV26');
      currentUser = null;
      whoBox.classList.add('hidden');
    }

    function parseCSV(text) {
      const rows = [];
      let cur = '', row = [], inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const char = text[i], next = text[i+1];
        if (char === '"') { if (inQuotes && next === '"') { cur += '"'; i++; } else inQuotes = !inQuotes; }
        else if (char === ',' && !inQuotes) { row.push(cur); cur = ''; }
        else if ((char === '\n' || char === '\r') && !inQuotes) { if (cur !== '' || row.length) { row.push(cur); rows.push(row); row = []; cur = ''; } }
        else { cur += char; }
      }
      if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
      const header = rows.shift() || [];
      return rows.map(r => {
        const obj = {};
        for (let i=0; i<header.length; i++) obj[header[i].trim()] = (r[i] ?? '').trim();
        return obj;
      });
    }

    async function loadLoginList(){
      enterBtn.disabled = true;
      userSelect.innerHTML = '<option value="">-- Pilih nama --</option>';
      rolePreview.textContent = '-';
      pagePreview.textContent = '-';

      try {
        if (!LOGIN_CSV_URL) {
          loginRows = [
            { 'Username':'Guru A', 'Password':'(diabaikan)', 'Role':'Guru', 'Role Halaman':'Halaman 1' },
            { 'Username':'Wali Kelas', 'Password':'(diabaikan)', 'Role':'Wali', 'Role Halaman':'Halaman 1' },
            { 'Username':'Tata Usaha', 'Password':'(diabaikan)', 'Role':'Admin', 'Role Halaman':'Halaman 1' }
          ];
          gateInfo.innerHTML = 'Mode Demo: ganti LOGIN_CSV_URL di Konfigurasi agar menarik data asli dari sheet Login.';
        } else {
          gateInfo.innerHTML = '<i class="fa-solid fa-spinner spin mr-2"></i>Memuat daftar dari sheet Login...';
          const res = await fetch(LOGIN_CSV_URL, { cache: 'no-store' });
          if (!res.ok) throw new Error('Gagal memuat CSV Login');
          const text = await res.text();
          loginRows = parseCSV(text).map(normLoginRow).filter(r => (r['Username']||'').trim() !== '');
          gateInfo.innerHTML = 'Daftar petugas berhasil dimuat.';
        }

        userSelect.innerHTML = '<option value="">-- Pilih nama --</option>' +
          loginRows.map((r,i)=>`<option value="${i}">${r['Username']}</option>`).join('');
      } catch(e){
        console.error(e);
        gateInfo.innerHTML = '<span class="text-rose-700"><i class="fa-solid fa-triangle-exclamation mr-1"></i>Gagal memuat daftar Login. Periksa link CSV.</span>';
      }
    }

    function normLoginRow(o){
      const out = {};
      Object.keys(o).forEach(k=>{
        const key = k.toLowerCase();
        if (key.includes('username') || key.includes('nama')) out['Username'] = o[k];
        else if (key.includes('password') || key === 'pass') out['Password'] = o[k];
        else if (key.includes('role halaman') || key.includes('halaman')) out['Role Halaman'] = o[k];
        else if (key.includes('role')) out['Role'] = o[k];
        else out[k] = o[k];
      });
      return out;
    }

    userSelect.addEventListener('change', ()=>{
      const idx = userSelect.value;
      if (idx === '') { rolePreview.textContent='-'; pagePreview.textContent='-'; enterBtn.disabled = true; return; }
      const row = loginRows[Number(idx)];
      rolePreview.textContent = row['Role'] || '-';
      pagePreview.textContent = row['Role Halaman'] || '-';
      const allowed = (row['Role Halaman']||'').toLowerCase().includes('halaman 1') || (row['Role Halaman']||'').trim()==='';
      enterBtn.disabled = !allowed;
      if (!allowed) {
        gateInfo.innerHTML = '<span class="text-amber-700"><i class="fa-solid fa-circle-info mr-1"></i>Nama ini tidak untuk Halaman 1. Pilih yang lain.</span>';
      } else {
        gateInfo.innerHTML = 'Siap masuk sebagai <b>' + (row['Username']||'') + '</b>.';
      }
      currentUser = row;
    });

    enterBtn.addEventListener('click', showApp);
    refreshLoginList.addEventListener('click', loadLoginList);
    rememberToggle.addEventListener('click', (e) => {
      rememberDevice = !rememberDevice;
      e.currentTarget.innerHTML = rememberDevice
        ? '<i class="fa-regular fa-circle-check mr-1 text-emerald-600"></i>Ingat perangkat ini'
        : '<i class="fa-regular fa-circle mr-1 text-gray-400"></i>Jangan ingat perangkat';
    });

    // ================== Header Clock ==================
    function updateNow(){
      const now = new Date();
      const dOpt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      const h = String(now.getHours()).padStart(2,'0');
      const m = String(now.getMinutes()).padStart(2,'0');
      const s = String(now.getSeconds()).padStart(2,'0');
      const timeStr = `${h}:${m}:${s}`;
      const dateStr = now.toLocaleDateString('id-ID', dOpt);
      const dateEl = document.getElementById('nowDate');
      const timeEl = document.getElementById('nowTime');
      if (dateEl) dateEl.textContent = dateStr;
      if (timeEl) timeEl.textContent = timeStr;
      const mini = document.getElementById('clockMini'); if (mini) mini.textContent = `${dateStr} ${timeStr}`;
    }

    // ================== Tabs & Navigation ==================
    function switchTab(which){
      const absenBtn = document.getElementById('tabAbsensi');
      const rekapBtn = document.getElementById('tabRekapan');
      const semBtn = document.getElementById('tabRekapSemester');
      const editBtn = document.getElementById('tabEditAbsensi');

      const absen = document.getElementById('sectionAbsen');
      const rekap = document.getElementById('sectionRekap');
      const rekapSem = document.getElementById('sectionRekapSemester');
      const edit = document.getElementById('sectionEdit');

      const setActive = (btn, on) => { if (!btn) return; btn.classList.toggle('active', !!on); };

      if (which === 'absen'){
        setActive(absenBtn, true); setActive(rekapBtn, false); setActive(semBtn, false); setActive(editBtn, false);
        absen.classList.remove('hidden-section'); rekap.classList.add('hidden-section'); rekapSem.classList.add('hidden-section'); edit.classList.add('hidden-section');
      } else if (which === 'rekap'){
        setActive(absenBtn, false); setActive(rekapBtn, true); setActive(semBtn, false); setActive(editBtn, false);
        rekap.classList.remove('hidden-section'); absen.classList.add('hidden-section'); rekapSem.classList.add('hidden-section'); edit.classList.add('hidden-section');
      } else if (which === 'rekapSemester'){
        setActive(absenBtn, false); setActive(rekapBtn, false); setActive(semBtn, true); setActive(editBtn, false);
        rekapSem.classList.remove('hidden-section'); absen.classList.add('hidden-section'); rekap.classList.add('hidden-section'); edit.classList.add('hidden-section');
      } else if (which === 'edit'){
        setActive(absenBtn, false); setActive(rekapBtn, false); setActive(semBtn, false); setActive(editBtn, true);
        edit.classList.remove('hidden-section'); absen.classList.add('hidden-section'); rekap.classList.add('hidden-section'); rekapSem.classList.add('hidden-section');
      }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goToRekapan(){
      const chosen = selectedDate;
      switchTab('rekap');
      const setFilter = () => {
        const dInput = document.getElementById('rekapDate');
        if (chosen){
          dInput.value = chosen;
          applyFilters();
        } else {
          setTimeout(()=> dInput.focus(), 150);
        }
      };
      if (rawRows.length === 0) {
        loadData().then(setFilter).catch(()=>{});
      } else {
        setFilter();
      }
    }

    // ================== Absensi ==================
    let selectedDate = null;
    let currentSchedule = null;

    const students = [
      {name:"ALDRIAN RONALSON TITIHERU",gender:"L"},
      {name:"Alfian Adi Purnomo",gender:"L"},
      {name:"Aprilia Elisabet Yesnat",gender:"P"},
      {name:"Aurilius Tian Gerardo Saputra",gender:"L"},
      {name:"Bryan Edward Julyanto Bukari",gender:"L"},
      {name:"Cici Deswita Febriani",gender:"P"},
      {name:"CINTA LAURA HURULEA",gender:"P"},
      {name:"DANIYATI",gender:"P"},
      {name:"Deby Debora Kemesrar",gender:"P"},
      {name:"DELVERO EDWADT KALAMI",gender:"L"},
      {name:"ELDA W. KAMESFLE",gender:"P"},
      {name:"FALEN PRATAMA AYGE",gender:"L"},
      {name:"Falensia Marissa Runtu",gender:"P"},
      {name:"HARRY PANCA POLSIARY",gender:"L"},
      {name:"Herman Gabriel Fonataba",gender:"L"},
      {name:"Jessie Melissa Cantika Latue",gender:"P"},
      {name:"JUEN FRIDA LEKAHENA",gender:"P"},
      {name:"JUNIOR PASKAL TAHITU",gender:"L"},
      {name:"KIKI KHUSNUL OKTAVIANTI",gender:"P"},
      {name:"MARIA FRESENDA LEWATAKA",gender:"P"},
      {name:"MARIA MAGDALENA SNANFI",gender:"P"},
      {name:"Maya Rosaida Paa",gender:"P"},
      {name:"MELANI STEFANNY LOIWATU",gender:"P"},
      {name:"MUHAMMAD FADLAN",gender:"L"},
      {name:"NAOMI TRESIA PAITEI",gender:"P"},
      {name:"NATHALIA RUMBINO",gender:"P"},
      {name:"Novela Jessica Ta'bilangi",gender:"P"},
      {name:"OLGA I. LIKLIKWATIL",gender:"P"},
      {name:"RACHEL MANUELA MAYOR",gender:"P"},
      {name:"RATNA SARI ABDULMUIN",gender:"P"},
      {name:"Raymond Edwin Soselisa",gender:"L"},
      {name:"Rizky",gender:"L"},
      {name:"SAMUEL.FANIK.TEHUPEIORY",gender:"L"},
      {name:"Tiara Arung Silambi",gender:"P"},
      {name:"WULAN RAHMADANI",gender:"P"},
      {name:"ZAINU",gender:"L"}
    ];
    let attendance = {}; students.forEach(s => attendance[s.name] = 'Hadir');

    function setToday(){
      const d = new Date();
      const str = d.toISOString().split('T')[0];
      document.getElementById('attendanceDate').value = str;
      selectedDate = str; updateSelectedDate();
    }
    function setYesterday(){
      const d = new Date(); d.setDate(d.getDate()-1);
      const str = d.toISOString().split('T')[0];
      document.getElementById('attendanceDate').value = str;
      selectedDate = str; updateSelectedDate();
    }
    function updateSelectedDate(){
      const input = document.getElementById('attendanceDate');
      selectedDate = input.value || null;

      const label = document.getElementById('selectedDateDisplay');
      const badge = document.getElementById('dateBadge');

      if (!selectedDate){
        label.textContent = 'Belum dipilih';
        badge.textContent = '';
        badge.className = 'ml-2 px-2 py-0.5 text-xs font-medium rounded-full';
        return;
      }

      const dt = new Date(selectedDate);
      label.textContent = dt.toLocaleDateString('id-ID', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

      const todayStr = new Date().toISOString().split('T')[0];
      const y = new Date(); y.setDate(y.getDate()-1);
      const yStr = y.toISOString().split('T')[0];

      if (selectedDate === todayStr){
        badge.textContent = 'Hari Ini';
        badge.className = 'ml-2 px-2 py-0.5 text-xs font-medium rounded-full bg-emerald-100 text-emerald-700';
      } else if (selectedDate === yStr){
        badge.textContent = 'Kemarin';
        badge.className = 'ml-2 px-2 py-0.5 text-xs font-medium rounded-full bg-slate-100 text-slate-700';
      } else {
        const chosen = new Date(selectedDate);
        const today = new Date();
        if (chosen < new Date(today.toDateString())){
          badge.textContent = 'Masa Lalu';
          badge.className = 'ml-2 px-2 py-0.5 text-xs font-medium rounded-full bg-amber-100 text-amber-800';
        } else {
          badge.textContent = 'Masa Depan';
          badge.className = 'ml-2 px-2 py-0.5 text-xs font-medium rounded-full bg-fuchsia-100 text-fuchsia-800';
        }
      }
    }

    function selectSchedule(id){
      document.querySelectorAll('.schedule-btn').forEach(b=>{
        b.classList.remove('bg-indigo-600','text-white','bg-fuchsia-600');
        if (b.id.startsWith('jam')) b.classList.add('bg-indigo-100','text-indigo-800');
        else b.classList.add('bg-fuchsia-100','text-fuchsia-800');
      });
      const btn = document.getElementById(id);
      if (id.startsWith('jam')){
        btn.classList.remove('bg-indigo-100','text-indigo-800'); btn.classList.add('bg-indigo-600','text-white');
      } else {
        btn.classList.remove('bg-fuchsia-100','text-fuchsia-800'); btn.classList.add('bg-fuchsia-600','text-white');
      }
      const names = {
        jam1:'Jam 1', jam2:'Jam 2', jam3:'Jam 3', jam4:'Jam 4', jam5:'Jam 5',
        jam6:'Jam 6', jam7:'Jam 7', jam8:'Jam 8', jam9:'Jam 9',
        bimbel1:'Bimbel 1', bimbel2:'Bimbel 2'
      };
      currentSchedule = id;
      document.getElementById('selectedSchedule').textContent = names[id] || 'Belum dipilih';
    }

    function studentCard(s, i){
      const st = attendance[s.name];
      const icon = s.gender==='L' ? 'fa-mars text-blue-500' : 'fa-venus text-pink-500';
      return `
        <div class="border border-gray-200 rounded-lg p-3 sm:p-4 bg-white">
          <div class="flex flex-col gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2 py-1 rounded">${i+1}</span>
              <h4 class="font-semibold text-gray-800 text-sm sm:text-base">${s.name}</h4>
              <i class="fa-solid ${icon}"></i>
            </div>
            <div class="status-grid">
              <button onclick="setStatus('${s.name}','Hadir')" class="px-3 py-1.5 rounded-lg text-xs font-semibold ${st==='Hadir' ? 'bg-emerald-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-emerald-100'}"><i class="fa-solid fa-check mr-1"></i>Hadir</button>
              <button onclick="setStatus('${s.name}','Sakit')" class="px-3 py-1.5 rounded-lg text-xs font-semibold ${st==='Sakit' ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-amber-100'}"><i class="fa-solid fa-temperature-quarter mr-1"></i>Sakit</button>
              <button onclick="setStatus('${s.name}','Izin')"  class="px-3 py-1.5 rounded-lg text-xs font-semibold ${st==='Izin'  ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-indigo-100'}"><i class="fa-regular fa-hand mr-1"></i>Izin</button>
              <button onclick="setStatus('${s.name}','Alpa')"  class="px-3 py-1.5 rounded-lg text-xs font-semibold ${st==='Alpa'  ? 'bg-rose-600 text-white'   : 'bg-gray-100 text-gray-700 hover:bg-rose-100'}"><i class="fa-solid fa-xmark mr-1"></i>Alpa</button>
              <button onclick="setStatus('${s.name}','Bolos')" class="px-3 py-1.5 rounded-lg text-xs font-semibold ${st==='Bolos' ? 'bg-fuchsia-600 text-white': 'bg-gray-100 text-gray-700 hover:bg-fuchsia-100'}"><i class="fa-solid fa-user-slash mr-1"></i>Bolos</button>
            </div>
          </div>
        </div>
      `;
    }
    function setStatus(name, st){ attendance[name] = st; renderStudents(); }
    function markAllPresent(){ students.forEach(s=>attendance[s.name]='Hadir'); renderStudents(); }
    function renderStudents(){
      const wrap = document.getElementById('studentsList');
      wrap.innerHTML = students.map((s,i)=>studentCard(s,i)).join('');
      document.getElementById('studentCountLabel').textContent = `(${students.length} Siswa)`;
      document.getElementById('totalCount').textContent = students.length;
      document.getElementById('maleCount').textContent = students.filter(s=>s.gender==='L').length;
      document.getElementById('femaleCount').textContent = students.filter(s=>s.gender==='P').length;
    }

    async function submitAttendance(){
      const btn = document.getElementById('submitBtn');
      const ok = document.getElementById('successMessage');
      const err = document.getElementById('errorMessage');
      const warn = document.getElementById('urlWarning');
      const dup = document.getElementById('duplicateWarning');

      ok.classList.add('hidden'); err.classList.add('hidden'); err.textContent = '';
      if (dup) dup.classList.add('hidden');

      if (!scriptURL || scriptURL.includes('PASTE_YOUR_WEB_APP_URL_HERE')) {
        err.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i>URL Web App belum diisi.';
        err.classList.remove('hidden'); warn.scrollIntoView({behavior:'smooth'}); return;
      }
      if (!selectedDate){
        err.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i>Pilih tanggal dahulu.'; err.classList.remove('hidden'); err.scrollIntoView({behavior:'smooth'}); return;
      }
      if (!currentSchedule){
        err.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i>Pilih Jam ke / Bimbel dahulu.'; err.classList.remove('hidden'); err.scrollIntoView({behavior:'smooth'}); return;
      }

      // Cegah kiriman ganda (per perangkat)
      const pairKey = `${selectedDate}__${currentSchedule}`;
      const sentPairs = JSON.parse(localStorage.getItem('sentPairs')||'[]');
      if (sentPairs.includes(pairKey)){
        if (dup){ dup.classList.remove('hidden'); dup.scrollIntoView({behavior:'smooth'}); }
        return;
      }

      btn.innerHTML = '<i class="fa-solid fa-spinner spin mr-2"></i>Mengirim...'; btn.disabled = true;

      try{
        const payload = {
          selectedDate,
          schedule: currentSchedule,
          attendance,
          students,
          note: '', // dikosongkan karena kolom catatan dihapus dari UI
          user: currentUser ? { name: currentUser.Username, role: currentUser.Role } : null
        };

        await fetch(scriptURL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        sentPairs.push(pairKey);
        localStorage.setItem('sentPairs', JSON.stringify(sentPairs));

        ok.classList.remove('hidden');
        ok.scrollIntoView({behavior:'smooth'});
      } catch(e){
        err.innerHTML = '<i class="fa-solid fa-circle-exclamation mr-2"></i>Gagal mengirim. Coba lagi atau cek koneksi.';
        err.classList.remove('hidden');
        err.scrollIntoView({behavior:'smooth'});
      } finally {
        btn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i>Kirim Absensi';
        btn.disabled = false;
      }
    }

    // ================== Rekapan Harian (satu tanggal) ==================
    let rawRows = [];
    let filteredRows = [];
    let rekapPerNama = [];

    function normalizeRow(o) {
      const map = (k) => {
        const key = k.toLowerCase();
        if (key.includes('no')) return 'No.';
        if (key.includes('tanggal') || key.includes('date')) return 'Tanggal';
        if (key.includes('jam')) return 'Jam ke';
        if (key.includes('nama')) return 'Nama Lengkap';
        if (key.includes('kelamin') || key.includes('gender')) return 'Jenis Kelamin';
        if (key.includes('keterangan') || key.includes('status')) return 'Keterangan';
        return k;
      };
      const out = {};
      Object.keys(o).forEach(k => out[map(k)] = o[k]);
      const t = out['Tanggal'] || '';
      if (t && !/^\d{4}-\d{2}-\d{2}$/.test(t)) {
        const d = new Date(t);
        if (!isNaN(d.getTime())) out['Tanggal'] = d.toISOString().slice(0,10);
      }
      return out;
    }

    function fillJamOptions(list) {
      const jams = Array.from(new Set(list.map(r => r['Jam ke']).filter(Boolean))).sort((a,b)=>a.localeCompare(b, 'id'));
      const sel1 = document.getElementById('jamFilter');
      const sel2 = document.getElementById('jamFilterSem');
      const sel3 = document.getElementById('jamFilterEdit');
      const html = '<option value="">Semua</option>' + jams.map(j => `<option>${j}</option>`).join('');
      if (sel1) sel1.innerHTML = html;
      if (sel2) sel2.innerHTML = html;
      if (sel3) sel3.innerHTML = html;
    }

    function applyFilters() {
      const d = document.getElementById('rekapDate').value;
      const jam = document.getElementById('jamFilter').value;
      const status = document.getElementById('statusFilter').value;
      const q = (document.getElementById('searchName').value || '').toLowerCase().trim();

      filteredRows = rawRows.filter(r => {
        if (d && (r['Tanggal'] || '') !== d) return false;
        if (jam && (r['Jam ke'] || '') !== jam) return false;
        if (status && (r['Keterangan'] || '') !== status) return false;
        if (q && !(r['Nama Lengkap'] || '').toLowerCase().includes(q)) return false;
        return true;
      });

      const matchEl = document.getElementById('matchCount');
      if (matchEl) matchEl.textContent = filteredRows.length.toString();

      aggregatePerNama();
      renderRekapTable();
      renderSummary();
      document.getElementById('emptyBox').classList.toggle('hidden', filteredRows.length !== 0);
    }

    function aggregatePerNama() {
      const map = new Map();
      const statuses = ['Hadir','Sakit','Izin','Alpa','Bolos'];
      filteredRows.forEach(r => {
        const nama = r['Nama Lengkap'] || '(Tanpa Nama)';
        const st = r['Keterangan'] || '';
        if (!map.has(nama)) map.set(nama, { Nama:nama, Hadir:0,Sakit:0,Izin:0,Alpa:0,Bolos:0, Total:0 });
        const item = map.get(nama);
        if (statuses.includes(st)) item[st] += 1;
        item.Total += 1;
      });
      rekapPerNama = Array.from(map.values()).sort((a,b)=> a.Nama.localeCompare(b.Nama,'id'));
    }

    function renderSummary() {
      const sum = {Hadir:0,Sakit:0,Izin:0,Alpa:0,Bolos:0};
      filteredRows.forEach(r => { const st = r['Keterangan']; if (sum.hasOwnProperty(st)) sum[st] += 1; });
      document.getElementById('sumHadir').textContent = sum.Hadir;
      document.getElementById('sumSakit').textContent = sum.Sakit;
      document.getElementById('sumIzin').textContent = sum.Izin;
      document.getElementById('sumAlpa').textContent = sum.Alpa;
      document.getElementById('sumBolos').textContent = sum.Bolos;
      document.getElementById('sumTotal').textContent = filteredRows.length;
    }

    function renderRekapTable() {
      const tb = document.getElementById('rekapBody');
      tb.innerHTML = rekapPerNama.map((r, i) => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 text-gray-700">${i+1}</td>
          <td class="px-4 py-3 font-semibold text-gray-800">${r.Nama}</td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Hadir"><span class="status-dot" style="background:#16a34a"></span>${r.Hadir}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Sakit"><span class="status-dot" style="background:#ca8a04"></span>${r.Sakit}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Izin"><span class="status-dot" style="background:#4f46e5"></span>${r.Izin}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Alpa"><span class="status-dot" style="background:#e11d48"></span>${r.Alpa}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Bolos"><span class="status-dot" style="background:#a21caf"></span>${r.Bolos}</span></td>
          <td class="px-4 py-3 text-center font-bold text-gray-900">${r.Total}</td>
        </tr>
      `).join('');
    }

    function exportRekapCSV() {
      const header = ['No.','Nama Lengkap','Hadir','Sakit','Izin','Alpa','Bolos','Total'];
      const lines = [header.join(',')];
      rekapPerNama.forEach((r, i) => {
        const row = [i+1, r.Nama, r.Hadir, r.Sakit, r.Izin, r.Alpa, r.Bolos, r.Total]
          .map(v => {
            const s = String(v ?? '');
            return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replace(/"/g,'""') + '"' : s;
          })
          .join(',');
        lines.push(row);
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rekap_absen_per_nama.csv';
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ================== Rekapan Semester (rentang tanggal) ==================
    let filteredRowsSem = [];
    let rekapPerNamaSem = [];

    function applySemesterFilters() {
      const sDate = document.getElementById('semStartDate').value;
      const eDate = document.getElementById('semEndDate').value;
      const jam = document.getElementById('jamFilterSem').value;
      const status = document.getElementById('statusFilterSem').value;
      const q = (document.getElementById('searchNameSem').value || '').toLowerCase().trim();

      filteredRowsSem = rawRows.filter(r => {
        const t = (r['Tanggal'] || '');
        if (sDate && t < sDate) return false;
        if (eDate && t > eDate) return false;
        if (jam && (r['Jam ke'] || '') !== jam) return false;
        if (status && (r['Keterangan'] || '') !== status) return false;
        if (q && !(r['Nama Lengkap'] || '').toLowerCase().includes(q)) return false;
        return true;
      });

      document.getElementById('matchCountSem').textContent = filteredRowsSem.length.toString();

      aggregatePerNamaSem();
      renderRekapTableSem();
      renderSummarySem();
      document.getElementById('emptyBoxSem').classList.toggle('hidden', filteredRowsSem.length !== 0);
    }

    function aggregatePerNamaSem() {
      const map = new Map();
      const statuses = ['Hadir','Sakit','Izin','Alpa','Bolos'];
      filteredRowsSem.forEach(r => {
        const nama = r['Nama Lengkap'] || '(Tanpa Nama)';
        const st = r['Keterangan'] || '';
        if (!map.has(nama)) map.set(nama, { Nama:nama, Hadir:0,Sakit:0,Izin:0,Alpa:0,Bolos:0, Total:0 });
        const item = map.get(nama);
        if (statuses.includes(st)) item[st] += 1;
        item.Total += 1;
      });
      rekapPerNamaSem = Array.from(map.values()).sort((a,b)=> a.Nama.localeCompare(b.Nama,'id'));
    }

    function renderSummarySem() {
      const sum = {Hadir:0,Sakit:0,Izin:0,Alpa:0,Bolos:0};
      filteredRowsSem.forEach(r => { const st = r['Keterangan']; if (sum.hasOwnProperty(st)) sum[st] += 1; });
      document.getElementById('sumHadirSem').textContent = sum.Hadir;
      document.getElementById('sumSakitSem').textContent = sum.Sakit;
      document.getElementById('sumIzinSem').textContent = sum.Izin;
      document.getElementById('sumAlpaSem').textContent = sum.Alpa;
      document.getElementById('sumBolosSem').textContent = sum.Bolos;
      document.getElementById('sumTotalSem').textContent = filteredRowsSem.length;
    }

    function renderRekapTableSem() {
      const tb = document.getElementById('rekapBodySem');
      tb.innerHTML = rekapPerNamaSem.map((r, i) => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-3 text-gray-700">${i+1}</td>
          <td class="px-4 py-3 font-semibold text-gray-800">${r.Nama}</td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Hadir"><span class="status-dot" style="background:#16a34a"></span>${r.Hadir}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Sakit"><span class="status-dot" style="background:#ca8a04"></span>${r.Sakit}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Izin"><span class="status-dot" style="background:#4f46e5"></span>${r.Izin}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Alpa"><span class="status-dot" style="background:#e11d48"></span>${r.Alpa}</span></td>
          <td class="px-4 py-3 text-center"><span class="badge badge-Bolos"><span class="status-dot" style="background:#a21caf"></span>${r.Bolos}</span></td>
          <td class="px-4 py-3 text-center font-bold text-gray-900">${r.Total}</td>
        </tr>
      `).join('');
    }

    function exportRekapCSVSem() {
      const header = ['No.','Nama Lengkap','Hadir','Sakit','Izin','Alpa','Bolos','Total'];
      const lines = [header.join(',')];
      rekapPerNamaSem.forEach((r, i) => {
        const row = [i+1, r.Nama, r.Hadir, r.Sakit, r.Izin, r.Alpa, r.Bolos, r.Total]
          .map(v => {
            const s = String(v ?? '');
            return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replace(/"/g,'""') + '"' : s;
          })
          .join(',');
        lines.push(row);
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'rekap_absen_per_nama_semester.csv';
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ================== Edit Absensi (Demo) ==================
    let filteredRowsEdit = [];
    let editRows = [];
    const edits = {}; // key: 'Tanggal|Jam ke|Nama' => newStatus

    function makeKey(r){
      return `${r['Tanggal']||''}|${r['Jam ke']||''}|${r['Nama Lengkap']||''}`;
    }
    function currentStatusFor(r){
      const key = makeKey(r);
      return edits[key] ?? (r['Keterangan'] || '');
    }

    function applyEditFilters(){
      const d = document.getElementById('editDate').value;
      const jam = document.getElementById('jamFilterEdit').value;
      const q = (document.getElementById('searchNameEdit').value || '').toLowerCase().trim();

      editRows = rawRows.filter(r => {
        if (d && (r['Tanggal'] || '') !== d) return false;
        if (jam && (r['Jam ke'] || '') !== jam) return false;
        if (q && !(r['Nama Lengkap'] || '').toLowerCase().includes(q)) return false;
        return true;
      });

      document.getElementById('matchCountEdit').textContent = editRows.length.toString();
      renderEditTable();
      document.getElementById('emptyBoxEdit').classList.toggle('hidden', editRows.length !== 0);
    }

    function setEditStatus(key, status){
      edits[key] = status;
      renderEditTable();
    }

    function renderEditTable(){
      const tb = document.getElementById('editBody');
      const statuses = ['Hadir','Sakit','Izin','Alpa','Bolos'];
      tb.innerHTML = editRows.map((r, i) => {
        const cur = currentStatusFor(r);
        const key = makeKey(r);
        const buttons = statuses.map(st => {
          const active = cur === st;
          const base = 'px-2.5 py-1 rounded-lg text-xs font-semibold';
          const activeCls = {
            'Hadir':'bg-emerald-600 text-white',
            'Sakit':'bg-amber-600 text-white',
            'Izin':'bg-indigo-600 text-white',
            'Alpa':'bg-rose-600 text-white',
            'Bolos':'bg-fuchsia-600 text-white'
          }[st] || 'bg-gray-200 text-gray-800';
          const inactiveCls = 'bg-gray-100 text-gray-700 hover:bg-gray-200';
          return `<button class="${base} ${active ? activeCls : inactiveCls}" onclick="setEditStatus('${key}','${st}')">${st}</button>`;
        }).join(' ');
        return `
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-3 text-gray-700">${i+1}</td>
            <td class="px-4 py-3 font-semibold text-gray-800">${r['Nama Lengkap'] || ''}</td>
            <td class="px-4 py-3 text-gray-700">${r['Jam ke'] || '-'}</td>
            <td class="px-4 py-3"><div class="flex flex-wrap gap-2">${buttons}</div></td>
          </tr>
        `;
      }).join('');
    }

    function saveEditsDemo(){
      const changes = [];
      const set = new Set(Object.keys(edits));
      editRows.forEach(r => {
        const key = makeKey(r);
        if (!set.has(key)) return;
        const before = r['Keterangan'] || '';
        const after = edits[key];
        if (after && after !== before){
          changes.push({
            tanggal: r['Tanggal'] || '',
            jam: r['Jam ke'] || '',
            nama: r['Nama Lengkap'] || '',
            dari: before,
            ke: after
          });
        }
      });

      const ok = document.getElementById('editSaveMessage');
      const err = document.getElementById('editErrorMessage');
      ok.classList.add('hidden'); err.classList.add('hidden');

      if (changes.length === 0){
        ok.innerHTML = '<i class="fa-solid fa-circle-check mr-1"></i> Tidak ada perubahan baru.';
        ok.classList.remove('hidden');
        ok.scrollIntoView({behavior:'smooth'});
        return;
      }

      // Demo kirim
      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ type:'edit', items: changes })
      }).then(()=>{
        ok.classList.remove('hidden');
        ok.scrollIntoView({behavior:'smooth'});
      }).catch(()=>{
        err.classList.remove('hidden');
        err.scrollIntoView({behavior:'smooth'});
      });
    }

    function exportEditsCSV(){
      const lines = ['Tanggal,Jam ke,Nama Lengkap,Sebelum,Setelah'];
      const set = new Set(Object.keys(edits));
      editRows.forEach(r => {
        const key = makeKey(r);
        if (!set.has(key)) return;
        const before = r['Keterangan'] || '';
        const after = edits[key] || '';
        if (after && after !== before){
          const vals = [r['Tanggal']||'', r['Jam ke']||'', r['Nama Lengkap']||'', before, after]
            .map(v => {
              const s = String(v ?? '');
              return (s.includes(',') || s.includes('"') || s.includes('\n')) ? '"' + s.replace(/"/g,'""') + '"' : s;
            });
          lines.push(vals.join(','));
        }
      });
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'perubahan_absensi.csv';
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // ================== Load Data (shared) ==================
    async function loadData() {
      const loading1 = document.getElementById('loadingBox');
      const err1 = document.getElementById('errorBox');
      const empty1 = document.getElementById('emptyBox');

      const loading2 = document.getElementById('loadingBoxSem');
      const err2 = document.getElementById('errorBoxSem');
      const empty2 = document.getElementById('emptyBoxSem');

      try {
        if (loading1) loading1.classList.remove('hidden');
        if (loading2) loading2.classList.remove('hidden');
        if (err1) err1.classList.add('hidden'); if (empty1) empty1.classList.add('hidden');
        if (err2) err2.classList.add('hidden'); if (empty2) empty2.classList.add('hidden');

        const res = await fetch(CSV_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const parsed = parseCSV(text).map(normalizeRow);
        rawRows = parsed.filter(r => (r['Nama Lengkap']||'').trim() !== '');
        filteredRows = rawRows.slice();
        fillJamOptions(rawRows);

        // Set default tanggal untuk Rekapan harian (terbaru)
        const dates = rawRows.map(r => r['Tanggal']).filter(Boolean).sort();
        const dInput = document.getElementById('rekapDate');
        if (dates.length && dInput && !dInput.value) dInput.value = dates[dates.length-1];

        // Set default rentang semester (min - max)
        const sInput = document.getElementById('semStartDate');
        const eInput = document.getElementById('semEndDate');
        if (dates.length) {
          if (sInput && !sInput.value) sInput.value = dates[0];
          if (eInput && !eInput.value) eInput.value = dates[dates.length-1];
        }

        // Set default tanggal edit (terbaru)
        const editDateInput = document.getElementById('editDate');
        if (dates.length && editDateInput && !editDateInput.value) editDateInput.value = dates[dates.length-1];

        applyFilters();
        applySemesterFilters();
        applyEditFilters();

        if (loading1) loading1.classList.add('hidden');
        if (loading2) loading2.classList.add('hidden');
      } catch (e) {
        if (loading1) loading1.classList.add('hidden');
        if (loading2) loading2.classList.add('hidden');
        if (err1) err1.classList.remove('hidden');
        if (err2) err2.classList.remove('hidden');
        console.error(e);
      }
    }

    // ================== Init ==================
    document.addEventListener('DOMContentLoaded', () => {
      const remembered = localStorage.getItem('enteredV26Remember') === '1';
      const inSession = sessionStorage.getItem('enteredV26') === '1';
      if (remembered || inSession) {
        currentUser = { Username: localStorage.getItem('lastUserName') || 'Petugas', Role: localStorage.getItem('lastUserRole') || 'User' };
        showApp();
      }

      loadLoginList();
      document.getElementById('exitBtn').addEventListener('click', () => {
        localStorage.removeItem('enteredV26Remember');
        showGate();
      });

      enterBtn.addEventListener('click', () => {
        if (currentUser) {
          localStorage.setItem('lastUserName', currentUser.Username || '');
          localStorage.setItem('lastUserRole', currentUser.Role || '');
        }
      });

      updateNow(); setInterval(updateNow, 1000);

      setToday();
      renderStudents();

      // Rekapan Harian events
      document.getElementById('rekapDate').addEventListener('change', applyFilters);
      document.getElementById('jamFilter').addEventListener('change', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('searchName').addEventListener('input', () => {
        clearTimeout(window.__searchTimer1);
        window.__searchTimer1 = setTimeout(applyFilters, 200);
      });
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('exportBtn').addEventListener('click', exportRekapCSV);

      // Rekapan Semester events
      document.getElementById('semStartDate').addEventListener('change', applySemesterFilters);
      document.getElementById('semEndDate').addEventListener('change', applySemesterFilters);
      document.getElementById('jamFilterSem').addEventListener('change', applySemesterFilters);
      document.getElementById('statusFilterSem').addEventListener('change', applySemesterFilters);
      document.getElementById('searchNameSem').addEventListener('input', () => {
        clearTimeout(window.__searchTimer2);
        window.__searchTimer2 = setTimeout(applySemesterFilters, 200);
      });
      document.getElementById('refreshBtnSem').addEventListener('click', loadData);
      document.getElementById('exportBtnSem').addEventListener('click', exportRekapCSVSem);

      // Edit Absensi events
      document.getElementById('editDate').addEventListener('change', applyEditFilters);
      document.getElementById('jamFilterEdit').addEventListener('change', applyEditFilters);
      document.getElementById('searchNameEdit').addEventListener('input', () => {
        clearTimeout(window.__searchTimer3);
        window.__searchTimer3 = setTimeout(applyEditFilters, 200);
      });
      document.getElementById('saveEditsBtn').addEventListener('click', saveEditsDemo);
      document.getElementById('exportEditsBtn').addEventListener('click', exportEditsCSV);

      loadData();
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9722d1b154b75f6f',t:'MTc1NTcwMjY0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
